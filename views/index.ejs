<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickScribe</title>
  <link rel="stylesheet" href="stylesheets/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <h1>Quick<span class="brand-accent">Scribe</span></h1>
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search notes..." onkeyup="searchNotes()">
            </div>
        </div>
        <div class="filter-container">
            <button onclick="toggleFavoriteFilter()" id="favoriteFilterBtn" class="filter-btn">
                <i class="far fa-heart"></i> Show Favorites
            </button>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a href="/contact">Contact</a>
        </div>
    </nav>

    <!-- New Note Button -->
    <div class="new-note-container">
        <button onclick="toggleNewNoteForm()" class="new-note-btn">
            <i class="fas fa-plus"></i> New Note
        </button>
    </div>

    <!-- New Note Form -->
    <div id="newNoteForm" class="form" style="display: none;">
        <div class="form-header">
            <button onclick="toggleNewNoteForm()" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2>New Note</h2>
        </div>
        <form action="/create" method="post">
            <input type="text" name="Title" placeholder="Title" required>
            <textarea name="Description" rows="10" placeholder="Write your note here..." required></textarea>
            <input type="submit" value="Save Note">
        </form>
    </div>

    <!-- Notes Grid -->
    <div class="notes-grid">
        <% if(files.length > 0) { %>
            <% files.forEach((val) => { %>
                <div class="note-card" onclick="openNote('<%= val %>')" data-filename="<%= val %>">
                    <div class="note-actions" onclick="event.stopPropagation()">
                        <button class="favorite-btn" onclick="toggleFavorite(this, '<%= val %>')">
                            <i class="far fa-heart"></i>
                        </button>
                        <button class="delete-btn" onclick="confirmDelete('<%= val %>')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h2><%= val.replace('.txt', '') %></h2>
                </div>
            <% }) %>
        <% } else { %>
            <p class="no-notes">No notes yet...</p>
        <% } %>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this note?</p>
            <div class="modal-buttons">
                <button type="button" onclick="deleteNote()" class="confirm-delete">Delete</button>
                <button type="button" onclick="closeModal()" class="cancel-delete">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let noteToDelete = '';

        function openNote(filename) {
            window.location.href = `/files/${encodeURIComponent(filename)}`;
        }

        function confirmDelete(filename) {
            event.stopPropagation();
            noteToDelete = filename;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function deleteNote() {
            if (noteToDelete) {
                fetch(`/delete/${encodeURIComponent(noteToDelete)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Find and remove the deleted note card from DOM
                        const noteCard = document.querySelector(`.note-card[data-filename="${noteToDelete}"]`);
                        if (noteCard) {
                            noteCard.remove();
                        }
                        closeModal();
                        // Check if there are no more notes
                        const remainingNotes = document.querySelectorAll('.note-card');
                        if (remainingNotes.length === 0) {
                            document.querySelector('.notes-grid').innerHTML = '<p class="no-notes">No notes yet...</p>';
                        }
                    } else {
                        console.error('Failed to delete note');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        }

        function closeModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        let showingFavorites = false;

        // Load favorites from localStorage
        const favorites = new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));

        // Initialize favorite states
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.note-card').forEach(card => {
                const filename = card.dataset.filename;
                if (favorites.has(filename)) {
                    const heartIcon = card.querySelector('.favorite-btn i');
                    heartIcon.classList.remove('far');
                    heartIcon.classList.add('fas', 'favorite-active');
                }
            });
        });

        function toggleFavorite(btn, filename) {
            event.stopPropagation();
            const icon = btn.querySelector('i');
            const isNowFavorite = icon.classList.toggle('fas');
            icon.classList.toggle('far');
            icon.classList.toggle('favorite-active');

            if (isNowFavorite) {
                favorites.add(filename);
            } else {
                favorites.delete(filename);
            }

            // Save to localStorage
            localStorage.setItem('favorites', JSON.stringify([...favorites]));

            // If showing favorites only, hide unfavorited notes
            if (showingFavorites && !isNowFavorite) {
                btn.closest('.note-card').style.display = 'none';
            }
        }

        function toggleFavoriteFilter() {
            const btn = document.getElementById('favoriteFilterBtn');
            showingFavorites = !showingFavorites;
            btn.classList.toggle('active');
            
            document.querySelectorAll('.note-card').forEach(card => {
                const filename = card.dataset.filename;
                if (showingFavorites) {
                    card.style.display = favorites.has(filename) ? 'block' : 'none';
                } else {
                    card.style.display = 'block';
                }
            });

            // Update button text
            btn.innerHTML = showingFavorites ? 
                '<i class="fas fa-heart"></i> Show All' : 
                '<i class="far fa-heart"></i> Show Favorites';
        }

        function toggleNewNoteForm() {
            var newNoteForm = document.getElementById("newNoteForm");
            newNoteForm.style.display = newNoteForm.style.display === "none" ? "block" : "none";
        }

        function searchNotes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const noteCards = document.querySelectorAll('.note-card');
            
            noteCards.forEach(card => {
                const title = card.querySelector('h2').textContent.toLowerCase();
                if (title.includes(searchTerm)) {
                    card.style.display = 'block';
                    // Calculate similarity for sorting
                    card.dataset.similarity = calculateSimilarity(title, searchTerm);
                } else {
                    card.style.display = 'none';
                    card.dataset.similarity = 0;
                }
            });

            // Sort notes based on similarity
            const notesGrid = document.querySelector('.notes-grid');
            const sortedCards = Array.from(noteCards).sort((a, b) => {
                return b.dataset.similarity - a.dataset.similarity;
            });

            // Reorder notes
            sortedCards.forEach(card => notesGrid.appendChild(card));
        }

        function calculateSimilarity(str1, str2) {
            // Simple substring match score
            if (str1.startsWith(str2)) return 2; // Prefix match gets highest priority
            if (str1.includes(str2)) return 1;   // Contains match gets medium priority
            return 0;                            // No match
        }
    </script>
</body>
</html>
